{% extends "base.html" %}
{% block title %}SasksVoice ‚Äî Submit Your Post{% endblock %}

{% block extra_css %}
{% if recaptcha_key %}
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
{% endif %}
<style>
    /* Instagram Feed Section */
    .feed-section {
        padding: 60px 24px 40px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .feed-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 28px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .feed-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #e0dce8;
    }

    .feed-title i {
        background: linear-gradient(135deg, #6c5ce7, #a855f7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .search-bar {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .search-input {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #e0dce8;
        padding: 10px 16px;
        border-radius: 12px;
        font-size: 0.9rem;
        width: 280px;
    }

    .search-input:focus {
        outline: none;
        border-color: #a855f7;
        box-shadow: 0 0 15px rgba(168, 85, 247, 0.15);
    }

    .search-input::placeholder {
        color: #7a7590;
    }

    .search-btn {
        background: linear-gradient(135deg, #6c5ce7, #a855f7);
        color: #fff;
        border: none;
        padding: 10px 18px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .category-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }

    .cat-tab {
        padding: 6px 16px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #c8c4d8;
        font-size: 0.82rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .cat-tab:hover,
    .cat-tab.active {
        background: linear-gradient(135deg, #6c5ce7, #a855f7);
        color: #fff;
        border-color: transparent;
    }

    .feed-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 16px;
    }

    .feed-card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

    .feed-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
    }

    .feed-card img {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
    }

    .feed-card-body {
        padding: 12px 14px;
    }

    .feed-card-caption {
        color: #c8c4d8;
        font-size: 0.82rem;
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .feed-card-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
        font-size: 0.75rem;
        color: #7a7590;
    }

    .feed-empty {
        grid-column: 1/-1;
        text-align: center;
        padding: 60px;
        color: #7a7590;
    }

    .violation-alert {
        background: rgba(255, 82, 82, 0.1);
        border: 1px solid rgba(255, 82, 82, 0.3);
        border-radius: 12px;
        padding: 14px 18px;
        color: #ff5252;
        font-size: 0.9rem;
        margin-top: 10px;
        display: none;
    }

    .violation-alert i {
        margin-right: 6px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Submission Form ‚Äî Direct without hero -->
<section class="submit-section" id="submit-section" style="padding-top: 40px;">
    <div class="form-container">
        <div class="form-header">
            <h2 class="form-title">Submit Your Post</h2>
            <p class="form-subtitle">Fill in the details below to submit your content</p>
        </div>

        <form action="{{ url_for('main.submit') }}" method="POST" enctype="multipart/form-data" id="submission-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- Name -->
            <div class="form-group">
                <label for="name" class="form-label">
                    <i class="bi bi-person"></i> Name <span class="optional-badge">Optional</span>
                </label>
                <input type="text" id="name" name="name" class="form-input"
                    placeholder="Your name (displayed with post)">
            </div>

            <!-- Email -->
            <div class="form-group">
                <label for="email" class="form-label">
                    <i class="bi bi-envelope"></i> Email <span class="optional-badge" id="email-badge">Optional</span>
                </label>
                <input type="email" id="email" name="email" class="form-input"
                    placeholder="For tracking your submission & payment receipts">
                <small id="email-note" style="display:none; color: var(--warning); font-size: 0.8rem; margin-top: 6px;">
                    ‚ö†Ô∏è Email is required for promotional posts (to verify your payment)
                </small>
            </div>

            <!-- Image Upload (Multiple) -->
            <div class="form-group">
                <label for="images" class="form-label">
                    <i class="bi bi-images"></i> Images <span class="optional-badge">Optional</span>
                    <span style="font-size: 0.8rem; color: var(--text-muted); margin-left: 8px;">Upload up to 10 images
                        for a carousel</span>
                </label>
                <div class="upload-zone" id="image-upload-zone">
                    <input type="file" id="images" name="images" accept="image/*" multiple class="file-input">
                    <div class="upload-placeholder" id="image-placeholder">
                        <i class="bi bi-cloud-arrow-up"></i>
                        <p>Drag & drop or click to upload</p>
                        <span>PNG, JPG, GIF, WebP ‚Äî Max 16MB each ‚Äî Up to 10 images</span>
                    </div>
                    <div class="upload-preview-grid" id="image-preview-grid" style="display:none;">
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center" style="margin-top: 6px;">
                    <small style="color: var(--text-muted); font-size: 0.82rem;">
                        üí° No image? No problem! We'll auto-generate a stylish text post image for you.
                    </small>
                    <button type="button" class="btn btn-sm" onclick="clearAllImages()" id="clear-images-btn"
                        style="display:none; font-size: 0.75rem; padding: 2px 10px; background: rgba(255,92,108,0.15); color: #ff5c6c; border: 1px solid rgba(255,92,108,0.3); border-radius: 6px;">
                        <i class="bi bi-x"></i> Clear All
                    </button>
                </div>
            </div>

            <!-- Video Upload -->
            <div class="form-group">
                <label for="video" class="form-label">
                    <i class="bi bi-camera-video"></i> Video <span class="optional-badge">Optional</span>
                </label>
                <div class="upload-zone upload-zone-sm" id="video-upload-zone">
                    <input type="file" id="video" name="video" accept="video/*" class="file-input">
                    <div class="upload-placeholder" id="video-placeholder">
                        <i class="bi bi-film"></i>
                        <p>Upload a video (optional)</p>
                        <span>MP4, MOV, AVI ‚Äî Max 16MB</span>
                    </div>
                    <div class="upload-preview-name" id="video-preview" style="display:none;">
                        <i class="bi bi-file-earmark-play-fill"></i>
                        <span id="video-name"></span>
                        <button type="button" class="remove-file-sm" onclick="removeVideo()"><i
                                class="bi bi-x"></i></button>
                    </div>
                </div>
            </div>

            <!-- Caption -->
            <div class="form-group">
                <label for="caption" class="form-label">
                    <i class="bi bi-chat-text"></i> Caption <span class="required-badge">Required</span>
                </label>
                <textarea id="caption" name="caption" class="form-textarea" rows="4" maxlength="2200" required
                    placeholder="Write your caption here... Max 2200 characters"></textarea>
                <div class="char-count"><span id="char-count">0</span>/2200</div>
                <!-- Content violation alert -->
                <div class="violation-alert" id="violation-alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span id="violation-message"></span>
                </div>
            </div>

            <!-- Post Type -->
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-tag"></i> Post Type
                </label>
                <div class="post-type-selector">
                    <label class="type-option selected" id="type-free">
                        <input type="radio" name="post_type" value="free" checked>
                        <div class="type-card">
                            <div class="type-icon"><i class="bi bi-gift"></i></div>
                            <div class="type-info">
                                <h4>Free Post</h4>
                                <p>Standard community post</p>
                            </div>
                            <div class="type-price">Free</div>
                        </div>
                    </label>
                    <label class="type-option" id="type-promo">
                        <input type="radio" name="post_type" value="promotional">
                        <div class="type-card">
                            <div class="type-icon"><i class="bi bi-rocket-takeoff"></i></div>
                            <div class="type-info">
                                <h4>Promotional Post</h4>
                                <p>Instant publish ‚Äî no review needed</p>
                            </div>
                            <div class="type-price">$2</div>
                        </div>
                    </label>
                </div>
                <input type="hidden" name="promo_amount" id="promo_amount" value="2.00">
            </div>

            <!-- reCAPTCHA -->
            {% if recaptcha_key %}
            <div class="form-group">
                <div class="g-recaptcha" data-sitekey="{{ recaptcha_key }}" data-theme="dark"></div>
            </div>
            {% endif %}

            <!-- Submit Button -->
            <button type="submit" class="submit-btn" id="submit-btn">
                <span class="btn-text">Submit Post</span>
                <span class="btn-loader" style="display:none;"><i class="bi bi-arrow-repeat spin"></i>
                    Submitting...</span>
            </button>
        </form>
    </div>
</section>

<!-- Instagram Feed Section -->
<section class="feed-section" id="feed-section">
    <div class="feed-header">
        <h2 class="feed-title"><i class="bi bi-instagram"></i> Recent Posts on @sasksvoice</h2>
        <div class="search-bar">
            <input type="text" class="search-input" id="feed-search" placeholder="Search posts...">
            <button class="search-btn" onclick="searchPosts()"><i class="bi bi-search"></i></button>
        </div>
    </div>

    <div class="category-tabs" id="category-tabs">
        <span class="cat-tab active" data-cat="all" onclick="filterCategory('all', this)">All</span>
        <span class="cat-tab" data-cat="community" onclick="filterCategory('community', this)">Community</span>
        <span class="cat-tab" data-cat="news" onclick="filterCategory('news', this)">News</span>
        <span class="cat-tab" data-cat="events" onclick="filterCategory('events', this)">Events</span>
        <span class="cat-tab" data-cat="housing" onclick="filterCategory('housing', this)">Housing</span>
        <span class="cat-tab" data-cat="food" onclick="filterCategory('food', this)">Food</span>
        <span class="cat-tab" data-cat="sports" onclick="filterCategory('sports', this)">Sports</span>
        <span class="cat-tab" data-cat="promotional" onclick="filterCategory('promotional', this)">Promotional</span>
    </div>

    <div class="feed-grid" id="feed-grid">
        {% if published_posts %}
        {% for post in published_posts %}
        <div class="feed-card" data-caption="{{ post.caption|lower }}" data-type="{{ post.post_type }}">
            {% if post.image_path %}
            <img src="{{ url_for('admin.serve_media', filepath=post.image_path) }}" alt="Post image" loading="lazy">
            {% endif %}
            <div class="feed-card-body">
                <div class="feed-card-caption">{{ post.caption[:150] }}</div>
                <div class="feed-card-meta">
                    <span>{{ post.submitter_name or 'Anonymous' }}</span>
                    <span>{{ post.published_at.strftime('%b %d') if post.published_at else '' }}</span>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="feed-empty">
            <i class="bi bi-instagram" style="font-size: 3rem; opacity: 0.3; display: block; margin-bottom: 12px;"></i>
            <p>No published posts yet. Be the first to submit!</p>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/submission.js') }}"></script>
<script>
    // ‚îÄ‚îÄ Content Moderation (LLM-based) ‚îÄ‚îÄ
    let moderationTimeout;
    const captionEl = document.getElementById('caption');
    const violationAlert = document.getElementById('violation-alert');
    const violationMsg = document.getElementById('violation-message');

    if (captionEl) {
        captionEl.addEventListener('input', function () {
            clearTimeout(moderationTimeout);
            const text = this.value.trim();
            if (text.length > 10) {
                moderationTimeout = setTimeout(() => checkContentViolation(text), 800);
            } else {
                violationAlert.style.display = 'none';
            }
        });
    }

    async function checkContentViolation(text) {
        try {
            const resp = await fetch('/api/check-content', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ caption: text })
            });
            const data = await resp.json();
            if (data.flagged) {
                violationMsg.textContent = data.reason;
                violationAlert.style.display = 'block';
                document.getElementById('submit-btn').disabled = true;
            } else {
                violationAlert.style.display = 'none';
                document.getElementById('submit-btn').disabled = false;
            }
        } catch (e) {
            // Silently fail ‚Äî don't block submission if API is down
            violationAlert.style.display = 'none';
            document.getElementById('submit-btn').disabled = false;
        }
    }

    // ‚îÄ‚îÄ Feed Search & Filter ‚îÄ‚îÄ
    function searchPosts() {
        const query = document.getElementById('feed-search').value.toLowerCase();
        document.querySelectorAll('.feed-card').forEach(card => {
            const caption = card.dataset.caption || '';
            card.style.display = caption.includes(query) ? '' : 'none';
        });
    }

    document.getElementById('feed-search')?.addEventListener('keyup', function (e) {
        if (e.key === 'Enter') searchPosts();
        if (this.value === '') {
            document.querySelectorAll('.feed-card').forEach(c => c.style.display = '');
        }
    });

    function filterCategory(cat, el) {
        document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');

        document.querySelectorAll('.feed-card').forEach(card => {
            if (cat === 'all') {
                card.style.display = '';
            } else {
                const caption = card.dataset.caption || '';
                const type = card.dataset.type || '';
                const match = caption.includes(cat) || type === cat;
                card.style.display = match ? '' : 'none';
            }
        });
    }
</script>
{% endblock %}